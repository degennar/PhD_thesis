\cleardoublepage
\chapter[Band structures of semiconductors and insulators]{Band structures of semiconductors\break and insulators\label{ch:band-structures}}
In this chapter we discuss the details of practical calculations, and the results obtained for a manifold of reference insulating materials. Thanks to the validity of Bloch's theorem, discussed in \cref{ch:koopmans-periodic}, it is possible to obtain electronic band structures -- within the primitive cell's BZ -- either from a supercell approach, by means of an unfolding method, or from the primitive cell implementation described in \cref{sec:koopmans-pbc}. The computational details of the calculations, including the description of the unfolding method and of the Koopmans workflow, are discussed in \cref{sec:calculations-koopmans}, while in \cref{sec:results-bands} we report the obtained results.

Part of the content of this chapter, as well as the reported results, have been published in Refs.~\cite{de_gennaro_blochs_2022,colonna_koopmans_2022}.

\clearpage
\section{Calculations with Koopmans functionals\label{sec:calculations-koopmans}}
Electronic-structure calculations using Koopmans spectral functionals are performed following two different approaches, based on the two strategies to compute the screening parameters discussed in \cref{sec:screening-parameters}: the first makes use of the finite energy differences strategy and relies on the SC method to model the system deprived of a particle, the second resorts to linear response theory and takes full advantage of the system's symmetries by exploiting the Wannier-like nature of the variational orbitals. The two approaches have different implementations -- called \kcp and \texttt{KCW} -- and different workflows, which will be further discussed in \cref{sec:computational-codes}.

The former represents the original approach used to perform the first calculations in crystalline materials \cite{nguyen_koopmans-compliant_2018}, although, in that case, the quasiparticle energies were computed only at the $\Gamma$-point of the SC (no information about the $\bk$-dispersion). By means of an unfolding technique -- which, once again seizes on the fact that the variational orbitals are WFs, to reconstruct the $\bk$-dependence of the Koopmans Hamiltonian -- here we show, for the very first time, band structures calculations from Koopmans functionals along any path in the BZ \cite{de_gennaro_blochs_2022} (from now on, when speaking of the BZ, we will implicitly refer to the PC's BZ, since the one corresponding to the SC always consists of the $\Gamma$-point only). We remark that this approach is the most complete one as it offers the possibility to perform calculations for any Koopmans functionals, and it contains a direct energy minimization algorithm that allows to compute the variational orbitals in a self-consistent way.

The second approach came out more recently \cite{colonna_koopmans_2022} and relies on a second-order approximation of the $\Pi_i$ terms which, for the moment, has been developed only for the KI functional. Also it does not include any variational procedure, which means that the variational orbitals are selected in a non-self-consistent way. On the bright side, the linear response approach does not require to compute the self-consistent energies of the system with an additional electron or hole -- the screening parameters are computed directly on the neutral system via density-functional perturbation theory (DFPT) -- which makes the calculations much simpler and computationally feasible with respect to the SC approach. Although most of the work carried out in this thesis was performed using the SC approach, in this chapter we will describe also the PC implementation and show some results obtained with this method.

A big part of this thesis was dedicated to the development of some parts of the computational code, to reach a stable implementation working for periodic systems, together with an optimization of the entire workflow required to perform calculations of Koopmans functionals in crystalline materials. In the following sections we give a detailed description of these aspects.


\subsection{Unfolding and interpolation method\label{sec:unfolding-method}}
When simulating a bulk crystalline material, the infinite system is usually studied with Born-von Karman (BvK) boundary conditions, which introduce a discretization of the $\bk$-points inside the BZ. Equivalently, one can study explicitly the BvK supercell containing the $N$ periodic replicas of the primitive cell but, as was already mentioned, in this case one no longer has direct access to the band structure of the primitive cell.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{WF-pcell-scell.pdf}
    \caption[Schematic representation of the map connecting PC's and SC's Wannier functions]{Schematic representation of a two-dimensional 2-band model showing the connection between the PC and SC Wannier representations. In the primitive picture with a $4\times 4$ sampling of the BZ, the WFs are identified with the pair of labels $\{ n,\bR \}$ (red labels): the cell index $\bR$ taking four values and the band index $n$ taking two values. In the $4\times 4$ SC with $\Gamma$-sampling of the BZ, the eight WFs are labeled by only one quantum number (black labels), i.e.\ the SC band index $\alpha$ running over the eight states.}
    \label{fig:map-wf}
\end{figure}

In order to recover this band structure, several methods have been developed \cite{boykin_practical_2005, lee_band_2005, ku_unfolding_2010, popescu_extracting_2012, huang_general_2014, medeiros_effects_2014, zheng_quantum_2015}; our approach follows the same strategy of \cite{lee_band_2005} and exploits the Wannier nature of the variational orbitals. By means of the transformation linking WFs and BFs [see \cref{eq:wannier-function}], the matrix elements of the $\bk$-space Hamiltonian are obtained from those given by the Wannier-like variational orbitals via a (double) Fourier transform:
%
\begin{equation}
    \begin{split}
        h^{\rm KC}_{mn}(\bk,\bk') &= \sum_{\bR,\bR'} e^{-i\bk \cdot \bR} e^{i\bk' \cdot \bR'} \braket{w_{m\bR} | \hat{h}^{\rm KC}_{n\bR'} | w_{n\bR'}} \\
        &= \sum_{\bR,\bR'} e^{-i\bk \cdot \bR} e^{i\bk' \cdot \bR'} h^{\rm KC}_{mn}(\bR,\bR') ,
    \end{split}
    \label{eq:double-k-ham}
\end{equation}
%
where we introduced the matrix elements $h^{\rm KC}_{mn}(\bR,\bR') = \braket{w_{m\bR} | \hat{h}^{\rm KC}_{n\bR'} | w_{n\bR'}}$. If the Koopmans Hamiltonian is compliant with the translation symmetries of the system, the matrix elements satisfy the property
%
\begin{equation}
    \begin{split}
        h^{\rm KC}_{mn}(\bR,\bR') &= \braket{w_{m\bR} | \hat{h}^{\rm KC}_{n\bR'} | w_{n\bR'}} \\
        &= \braket{w_{m{\bm 0}} | \hat{h}^{\rm KC}_{n\bR'-\bR} | w_{n\bR'-\bR}} \\
        &= h^{\rm KC}_{mn}({\bm 0},\bR'-\bR) \equiv h^{\rm KC}_{mn}(\bR'-\bR) ,
    \end{split}
    \label{eq:trans-prop-koopmans-matrix-elements}
\end{equation}
%
that, if used in \cref{eq:double-k-ham}, yields a block-diagonal matrix (as expected from Bloch's theorem)
%
\begin{equation}
    h^{\rm KC}_{mn}(\bk,\bk') = h^{\rm KC}_{mn}(\bk) \delta(\bk - \bk')
    \label{eq:block-diagonal-koopmans-ham}
\end{equation}
%
with
%
\begin{equation}
    h^{\rm KC}_{mn}(\bk) = \sum_{\bR} e^{i \bk \cdot \bR} \braket{w_{m\bm{0}} | \hat{h}^{\rm KC}_{n\bR} | w_{n\bR}} = \sum_{\bR} e^{i \bk \cdot \bR} h^{\rm KC}_{mn}(\bR) ,
    \label{eq:hk-unfold}
\end{equation}
%
The diagonalization of the Hamiltonian with matrix elements defined by \cref{eq:hk-unfold}, yields the quasiparticle energies $\varepsilon_{n\bk}$ at any $\bk$-point.

In the SC approach the Brillouin zone reduces to a single point; as a consequence, the SC Hamiltonian in the Wannier representation loses the information about the lattice vectors $\{\bR\}$ and its matrix elements are labeled by the SC index only. In order to reconstruct the $\bk$-space Hamiltonian of \cref{eq:hk-unfold}, one must reconstruct the composite index $\{n,\bR\}$ of each WF from its supercell-picture index ${\alpha}$ (see \cref{fig:map-wf}). An effective way to do this is to first choose a reference PC and define the orbitals with the centers inside it as the ``$\bR=\bm{0}$ Wannier functions''. The second step consists of comparing all the other WFs in the supercell with those in the reference cell. If the Wannier translation property holds, we are able to connect each WF to its reference function $w_{\bm{0} n}$ and lattice vector $\bR$, defined as the distance between the centers of the two functions. If the system has more functions sharing the same center, one can look at the second-order moments ($\braket{x^2}$, $\braket{y^2}$, $\braket{z^2}$) to have a more detailed signature of WFs and, if needed, can move towards higher-order spatial moments until the character of each Wannier function is unequivocally defined \cite{shelley_automated_2011}.

As argued in Ref.~\cite{lee_band_2005}, \cref{eq:hk-unfold} not only applies to the points belonging to the $\bk$-mesh commensurate with the chosen supercell, but it is also an excellent interpolator. So, in order to calculate the band structure along any path in the Brillouin zone, we obtain the matrix elements of the $\bk$-space Hamiltonian by simply applying \cref{eq:hk-unfold} to any arbitrary $\bk$-point. In doing so, two approximations are applied to the matrix elements. To highlight such approximations -- and, especially, justify the fact that they have a negligible effect -- let us consider a point $\bk'$ which does not belong to the original sampling $\{ \bk \}$ of the BZ. In \cref{eq:hk-unfold}, the $\bk$-points must be commensurate\footnote{
A regular sampling of the BZ, made of $N_1 \times N_2 \times N_3$ $\bk$-points generates a system consisting of $N_1 \times N_2 \times N_3$ repetitions of the unit cell, each of which is identified by a lattice vector $\bR$; a set $\{ \bk \}$ which samples (regularly) the BZ is said to be commensurate to $\{ \bR \}$ (and viceversa) if the latter is the direct lattice with PBC set by $\{ \bk \}$.
}
with the set of lattice vectors $\{ \bR \}$ over which the sum runs, therefore, in order to compute the matrix elements $h^{\rm KC}_{mn}(\bk')$ we should, in principle, sum over a set $\{ \bR' \}$ which is commensurate to a sampling of the BZ that includes the point $\bk'$. When interpolating the matrix elements of the $\bk$-space Hamiltonian, we apply then a zero-padding technique \cite{buongiorno_nardelli_paoflow_2018}, where the contributions coming from the bigger lattice $\{ \bR' \}$ are neglected:
%
\begin{equation}
    \begin{split}
        h^{\rm KC}_{mn}(\bk') &= \sum_{\bR'} e^{i \bk' \cdot \bR'} \braket{w_{m\bm{0}} | \hat{h}^{\rm KC}_{n\bR'} | w_{n\bR'}}_{V'} \\
        &= \sum_{\bR} e^{i \bk \cdot \bR} \braket{w_{m\bm{0}} | \hat{h}^{\rm KC}_{n\bR} | w_{n\bR}}_{V'} + \sum_{\bR' \neq \bR} e^{i \bk \cdot \bR'} \braket{w_{m\bm{0}} | \hat{h}^{\rm KC}_{n\bR'} | w_{n\bR'}}_{V'} \\
        &\approx \sum_{\bR} e^{i \bk \cdot \bR} \braket{w_{m\bm{0}} | \hat{h}^{\rm KC}_{n\bR} | w_{n\bR}}_{V}
    \end{split}
    \label{eq:hk-interpolated}
\end{equation}
%
where $V$ and $V'$ are the volumes of the lattices $\{ \bR \}$ and $\{ \bR' \}$. In the last step the terms corresponding to lattice vectors not belonging to the original lattice -- i.e. $\bR' \neq \bR$ -- are neglected, and the integral to evaluate the matrix elements $h^{\rm KC}_{mn}(\bR)$ is calculated over the volume $V$ (rather than $V'$). The accuracy of the approximation is higher the smaller the contribution from these terms, i.e. the more localized the variational orbitals are, or the larger the supercell becomes. A poorly interpolated band structure is usually symptom of a significant contribution from the matrix elements corresponding to larger $\bR$-vectors, or of a non-negligible integral coming from the region $V' \setminus V$ in the calculation of the matrix elements $h^{\rm KC}_{mn}(\bR)$. Ultimately, the effects of such approximations are reduced by increasing the size of the supercell.

\subsubsection*{Smooth interpolation method}
As a consequence of what was just discussed, when reconstructing the band structure from a supercell calculation, one faces a trade-off: on one hand, a sufficiently large SC must be used to minimize the errors associated with neglecting long-range matrix elements of the Hamiltonian. But on the other hand, increasing the size of the SC dramatically increases the computational costs. In this scenario, one can exploit the fact that the Koopmans potential is a small, slowly varying correction on top of the original DFT Hamiltonian. If one decomposes the right-hand side of \cref{eq:hk-unfold} in its DFT and KC components,
%
\begin{equation}
    h^{\rm KC}_{mn}(\bR) \longrightarrow h^{\rm DFT}_{mn}(\bR) + v^{\rm KC}_{mn}(\bR) ,
\end{equation}
%
it is reasonable to assume that the major source of error comes from the interpolation of $h^{\rm DFT}_{mn}(\bR)$. This allows to improve the interpolation of the band structure by rewriting \cref{eq:hk-unfold} as
%
\begin{equation}
    h^{\rm KC}_{mn}(\bk) = \sum_{\bR'} e^{i \bk \cdot \bR'} h^{\rm DFT}_{mn}(\bR') + \sum_{\bR} e^{i \bk \cdot \bR} v^{\rm KC}_{mn}(\bR)
    \label{eq:hk-smooth}
\end{equation}
%
where the set of vectors $\{ \bR' \}$ now corresponds to a much larger supercell or, equivalently, it comes from a calculation with a denser $\bk$-points grid. This represents a significant saving in computational costs because the Koopmans calculation can be then performed on smaller supercells than would otherwise be necessary.

In order to have a consistent representation between (a) the DFT Hamiltonian defined  on a very dense grid, and (b) the KC potential on a coarser grid, it is important to have the same set of WFs for the two calculations. As long as this is fulfilled, the Koopmans Hamiltonian can be factorized as shown in \cref{eq:hk-smooth} and the DFT part can be obtained starting from a $\bk$-points grid dense enough to reliably interpolate the band structure.

We stress that this method has the one goal of improving the interpolation of the band structure. The convergence of other results, such as total energies and eigenvalues on the $\bk$-points grid commensurate with the supercell, is typically achieved with relatively small supercells. The technique depicted above does not affect any of these quantities and only improves the results for the electronic eigenvalues at $\bk$-points not included in the original Monkhorst-Pack grid.

\subsection{Computational codes\label{sec:computational-codes}}
The workflow to perform a full calculation of Koopmans functionals is rather complex, and follows different steps, each of which requires several calculations. The computation of the screening parameters is the most time-consuming part for both the implementations, as it requires multiple constrained self-consistent SC calculations in the finite-differences approach, and DFPT calculations involving double loops over the plane waves and the $\bk$-points in the linear response approach. Recently, efforts have been made to increase the computational efficiency by defining new strategies for the calculation of the screening parameters: a machine-learning-based approach developed by Schubert \emph{et al.} \cite{schubert_ml_2022}, which exploits the correlation between the shape of the (variational) orbital densities and the corresponding $\alpha_i$, has showed very promising results and could represent a breakthrough for KC calculations.

While the workflow for finite systems is simpler, though very similar, to the one for solids, here we specify to the latter case. For both the approaches, the entire procedure consists of three main steps: (i) the initialization, consisting of a standard DFT calculation followed by a Wannierization of the KS states, in order to obtain MLWFs that are either used as a non-self-consistent guess for the variational orbitals or as initial guess for the energy minimization; (ii) the computation of the screening parameters; (iii) the final Koopmans calculation followed, in the SC approach, by the unfolding procedure described in \cref{sec:unfolding-method}. Many efforts have been put into the automatization of the Koopmans workflow, which is now fully handled by a Python package \cite{linscott_koopmans_2022}, based on the atomic simulation environment (ASE) \cite{larsen_atomic_2017}. Below, we describe in detail the various steps workflow for the two approaches, while a schematic representation is showed in \cref{fig:workflow}.

\subsubsection{\kcp code and the finite-differences workflow}
The finite-differences approach is based on the \kcp implementation of Koopmans functionals, where \kcp stands for Koopmans-CP. This name stems from the fact that the Koopmans code was originally implemented (for technical reasons) within an old version of the Car-Parrinello (CP) code of the \qe (QE) distribution \cite{giannozzi_quantum_2009,giannozzi_advanced_2017}, although no part related to the proper CP molecular dynamics technique is normally used. \kcp allows performing spin-polarized calculations with both the KI and KIPZ functionals; also, it contains a direct energy minimization algorithm -- this is based on the conjugate-gradient and steepest-descent techniques, coupled with an implementation of the Gram-Schmidt orthogonalization method -- which is used to determine self-consistently the variational orbitals of the system. Besides, the ODD character of the energy gradient makes the minimization procedure much heavier with respect to standard DFT codes in terms of computational time and memory, due to the need to compute and store all the different orbital-dependent potentials. \kcp is a $\Gamma$-only code, which means that all the calculations are performed using the SC method. This is actually convenient in Koopmans functionals, where large unit cells are needed to reach a sufficient orbitals' localization (see discussion in \cref{sec:localization}), and represents the only way to compute the screening parameters by means of the finite-differences method. 

A standard workflow for periodic systems using the finite-differences approach starts from a DFT calculation using the LDA or PBE functional, followed by a Wannierization of the KS states. The KS-DFT calculation is carried out with the plane-waves (PW) code of QE, whereas the Wannier functions minimizing the spread functional of \cref{eq:wannier-spread-functional} -- i.e. the MLWFs -- are obtained from the Wannier90 code \cite{pizzi_wannier90_2020}. The computed WFs are then used to initialize the first Koopmans calculation using a set of trial screening parameters $\{ \alpha_i^{(0)} \}$, which are usually taken as the inverse of the dielectric constant (see \cref{sec:screening-parameters}). In the past, the initial KS-DFT calculation and the WFs were computed in an identical SC setup (same supercell and same energy cutoff) used then in \texttt{KCP}, in order to be consistent\footnote{
We remark that the philosophy of QE is that of expressing any wave function $\psi(\br)$ (as well as the other quantities of interest, such as the potentials, kinetic energy, etc.) as a linear combination of PWs, meaning that $\psi$ is described in terms of its Fourier components, $\{ \psi(\bG) \}$. Since the set of $\bG$-vectors is fully defined by the geometry of the cell and by the energy cutoff, the $\bG$-vectors, and so the Fourier components of $\psi$, are different between PC and SC.
}
with the input wave functions expected by the \kcp code. The problem with this strategy is that the resulting MLWFs would generally break the translation property \eqref{eq:trans-prop-wannier} with respect to the PC's lattice vectors. The $\Gamma$-only calculations reported in Ref.~\cite{nguyen_koopmans-compliant_2018} were not affected by this issue, whereas it became crucial in this work to find a way around it in order to recover the compliance with Bloch's theorem and be able to compute PC band structures. That was done by computing the MLWFs starting from a PC calculation with a sampling of the BZ commensurate to the SC used later on -- in this way the resulting WFs would satisfy \cref{eq:trans-prop-wannier} by construction -- and then unfolding such WFs from the PC to the SC. The procedure to extend the WFs from the PC to the SC was implemented within a private version of the QE \texttt{pw2wannier90} code.

\begin{figure}
    \centering
    \subfloat[]{\includegraphics[width=\linewidth]{dscf_workflow.png}} \\
    \subfloat[]{\includegraphics[width=\linewidth]{dfpt_workflow.png}}
    \caption[]{Schematic representation of the workflows for the (a) SC-based finite-differences approach and the (b) PC-based linear response approach, using PBE as base DFT functional.}
    \label{fig:workflow}
\end{figure}

Once the initialization step is concluded, two different directions can be taken: a non-self-consistent road, where the computed MLWFs are taken as variational orbitals with no further optimization, or a self-consistent road, where the MLWFs are the starting point for the energy minimization which brings to the actual self-consistent variational orbitals. For KI calculations, where the ground-state density is the same of the underlying DFT functional -- this corresponds also to the density given by the computed WFs -- the default strategy is represented by the first option; alternatively, given the interpretation of the KI functional as a KIPZ functional with a vanishingly small PZ term (see paragraph at the end of \cref{sec:variational-procedure}), the self-consistent variational orbitals can be obtained via an inner loop only minimization of the energy functional (no outer loop since we do not need to update the total density). For KIPZ calculations, since also the ground-state density changes, the variational orbitals are normally computed self-consistently via a combined outer-inner loop minimization. In this thesis we often report results obtained from a \emph{perturbative KIPZ} (pKIPZ) approach: essentially, this consists of a KIPZ calculation where the variational orbitals, as well as the screening parameters, are taken from a prior KI calculation.

After the variational orbitals have been obtained, the orbital-dependent screening parameters are computed. As discussed in \cref{sec:screening-parameters}, these are obtained performing constrained self-consistent calculations where the selected orbital is each time kept frozen, and its occupation is set to zero (for occupied states) or to one (for empty states). This allows to calculate the energy difference $\Delta E^{\rm KC}_i$ appearing in \cref{eq:screening-parameter-dscf} which, together with the expectation values of the DFT and Koopmans Hamiltonians over the frozen orbital, represent all the ingredients needed to compute $\alpha_i$. We point out that in this phase, counter-charge corrections are introduced in order to account for the spurious interactions between the periodic replicas of the introduced electric charge. Details about this aspect are given in \cref{sec:makov-payne}.

Finally, we perform a conclusive Koopmans calculation with the computed screening parameters. The resulting Hamiltonian is then unfolded to the PC and interpolated along a chosen path in the BZ; its eigenvalues provide the band structure of the system.

\subsubsection{\kcw code and the DFPT workflow}
The \kcw code contains a primitive cell implementation of Koopmans functionals (only for the KI functional, for the moment), where the screening parameters are computed from DFPT for a second-order approximation of the Koopmans correction terms \cite{colonna_koopmans_2022}. As for the standard KI workflow in the finite-differences approach, MLWFs are taken as a guess for the variational orbitals. The workflow then is pretty much the same of the one depicted for the finite-differences approach, with the only \emph{caveat} of the different method for the computation of $\{ \alpha_i \}$. Also, the absence of a ``PC to SC transition'' prevents the need for an unfolding technique to extend the WFs to the SC first, and to unfold the Koopmans Hamiltonian back to the PC after.

Since the release of the version 7.1 of QE (June 2022), \kcw is officially part of the QE package suite. On the other hand, \kcp, as well as the Python package handling the workflows, are part of a private repository which will be soon released \cite{linscott_koopmans_2022}.

\subsection{Counter-charge corrections\label{sec:makov-payne}}

\section{Results\label{sec:results-bands}}

\subsection{Finite differences\label{sec:results-dscf}}

\subsection{DFPT\label{sec:results-dfpt}}

